# QRadar Log Forwarding Configuration v4.2.0

# Global settings
module(load="omfwd")
module(load="mmjsonparse")

# Template for QRadar
template(name="QRadarFormat" type="string" string="<%PRI%>%TIMESTAMP:::date-rfc3339% %HOSTNAME% %app-name%: %msg%\\n")

# Main queue for reliable forwarding
main_queue(
    queue.type="linkedlist"
    queue.filename="qradar_main_queue"
    queue.maxdiskspace="2g"
    queue.size="100000"
    queue.dequeuebatchsize="1000"
    queue.saveonshutdown="on"
    queue.timeoutshutdown="10000"
)

# Ruleset for processing audit logs
ruleset(name="qradar_audit") {
    # EXECVE command reconstruction
    if $!msg contains 'type=EXECVE' then {
        set $.full_command = "";
        set $.a0 = re_extract($!msg, 'a0="([^"]*)"', 0, 1, "none");
        set $.a1 = re_extract($!msg, 'a1="([^"]*)"', 0, 1, "none");
        # ... extract up to a9
        set $.a9 = re_extract($!msg, 'a9="([^"]*)"', 0, 1, "none");

        set $.full_command = $.a0;
        if $.a1 != "none" then {
            set $.full_command = $.full_command + " " + $.a1;
        }
        if $.a2 != "none" then {
            set $.full_command = $.full_command + " " + $.a2;
        }
        # ... concatenate up to a9

        # Replace original message with reconstructed command
        set $!msg = `{"msg": $!msg, "cmd": $.full_command}`;
    }

    # Forward to QRadar
    action(
        type="omfwd"
        target="<QRADAR_IP>"
        port="<QRADAR_PORT>"
        protocol="tcp"
        template="QRadarFormat"
        queue.type="linkedlist"
        queue.size="50000"
        action.resumeRetryCount="-1"
    )
    stop
}

# Input for audit logs
if $syslogfacility-text == 'local3' then {
    call qradar_audit
}
