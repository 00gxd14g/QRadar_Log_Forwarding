# QRadar Log Forwarding Configuration v4.2.1

# Global settings
module(load="omfwd")
module(load="mmjsonparse")
module(load="omprogram")
module(load="imfile")

# Template for QRadar
template(name="QRadarFormat" type="string" string="<%PRI%>%TIMESTAMP:::date-rfc3339% %HOSTNAME% %app-name%: %msg%\\n")

# Main queue for reliable forwarding
main_queue(
    queue.type="linkedList",
    queue.filename="qradar_main_queue",
    queue.maxDiskSpace="2g",
    queue.size="100000",
    queue.dequeueBatchSize="1000",
    queue.saveOnShutdown="on",
    queue.timeoutShutdown="10000"
)

# Ruleset for processing audit logs
ruleset(name="qradar_audit") {
    # EXECVE command reconstruction
    if ($!msg contains 'type=EXECVE') then {
        action(
            type="omprogram"
            binary="/usr/local/bin/qradar_execve_parser.py"
            template="QRadarFormat"
        )
    }

    # Forward to QRadar
    action(
        type="omfwd",
        target="<QRADAR_IP>",
        port="<QRADAR_PORT>",
        protocol="tcp",
        template="QRadarFormat",
        queue.type="linkedList",
        queue.size="50000",
        action.resumeRetryCount="-1"
    )
    stop
}

# Input for audit logs
if $syslogfacility-text == 'local3' then {
    call qradar_audit
}
