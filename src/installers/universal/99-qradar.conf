# QRadar Log Forwarding Configuration v4.2.1
# This file is placed in /etc/rsyslog.d/

# Template for QRadar
template(name="QRadarFormat" type="string" string="<%PRI%>%TIMESTAMP:::date-rfc3339% %HOSTNAME% %app-name%: %msg%\\n")

# Ruleset for processing audit logs
ruleset(name="qradar_audit") {
    # EXECVE command reconstruction
    if ($msg contains 'type=EXECVE') then {
        action(
            type="omprog"
            binary="/usr/local/bin/qradar_execve_parser.py"
            template="QRadarFormat"
        )
    }

    # Forward to QRadar
    action(
        type="omfwd"
        target="<QRADAR_IP>"
        port="<QRADAR_PORT>"
        protocol="tcp"
        template="QRadarFormat"
        queue.type="linkedList"
        queue.size="50000"
        action.resumeRetryCount="-1"
    )
    stop
}

# Input for audit logs
if ($programname == 'audit' or $syslogfacility-text == 'local3') then {
    call qradar_audit
}
